<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quarterly Estimated Tax Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #eef2ff;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
        }
        
        .input-field {
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step-indicator.completed {
            background-color: #10b981;
            color: white;
        }
        
        .currency-input {
            position: relative;
        }
        
        .currency-input::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }
        
        .currency-input input {
            padding-left: 28px;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 5px;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error Screen */
        #errorScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fee2e2;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Results specific styles */
        .result-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
        }
        
        .payment-schedule-row:nth-child(odd) {
            background-color: #f9fafb;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .success-box {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-white text-lg">Loading Calculator...</p>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen">
        <div class="text-center p-8">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h1 class="text-2xl font-bold text-red-800 mb-2">License Error</h1>
            <p id="errorMessage" class="text-red-600">Unable to validate license.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="gradient-bg py-6 px-4">
            <div class="max-w-3xl mx-auto text-center">
                <img id="clientLogo" src="" alt="Logo" class="h-12 mx-auto mb-4 hidden">
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Quarterly Estimated Tax Calculator</h1>
                <p class="text-indigo-100">Calculate your quarterly tax payments and avoid penalties</p>
            </div>
        </header>

        <!-- Calculator Container -->
        <main class="max-w-3xl mx-auto px-4 py-8">
            <!-- Progress Steps -->
            <div class="flex justify-between mb-8" id="progressSteps">
                <div class="flex flex-col items-center">
                    <div class="step-indicator active w-10 h-10 rounded-full flex items-center justify-center font-semibold mb-2" data-step="1">1</div>
                    <span class="text-xs text-gray-600 hidden md:block">Income</span>
                </div>
                <div class="flex-1 h-0.5 bg-gray-200 self-center mx-2 mt-[-20px]"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-semibold bg-gray-200 text-gray-500 mb-2" data-step="2">2</div>
                    <span class="text-xs text-gray-600 hidden md:block">Deductions</span>
                </div>
                <div class="flex-1 h-0.5 bg-gray-200 self-center mx-2 mt-[-20px]"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-semibold bg-gray-200 text-gray-500 mb-2" data-step="3">3</div>
                    <span class="text-xs text-gray-600 hidden md:block">Filing Info</span>
                </div>
                <div class="flex-1 h-0.5 bg-gray-200 self-center mx-2 mt-[-20px]"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-semibold bg-gray-200 text-gray-500 mb-2" data-step="4">4</div>
                    <span class="text-xs text-gray-600 hidden md:block">Results</span>
                </div>
            </div>

            <!-- Calculator Card -->
            <div class="bg-white rounded-2xl card-shadow p-6 md:p-8">
                <!-- Step 1: Income Information -->
                <div id="step1" class="step-content fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Step 1: Income Information</h2>
                    <p class="text-gray-600 mb-6">Enter your expected annual income for the tax year.</p>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                W-2 Wages (if any)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Income from traditional employment">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="w2Wages" value="0" min="0" 
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Self-Employment / Business Income
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="1099 income, freelance, business revenue">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="selfEmploymentIncome" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Other Income
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Investments, rental income, dividends, etc.">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="otherIncome" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button onclick="nextStep(2)" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 2: Deductions -->
                <div id="step2" class="step-content hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Step 2: Deductions & Expenses</h2>
                    <p class="text-gray-600 mb-6">Enter your business expenses and deductions.</p>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Total Business Expenses
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="All deductible business costs">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="businessExpenses" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Retirement Contributions (SEP-IRA, Solo 401k, etc.)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Tax-deductible retirement savings">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="retirementContributions" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Health Insurance Premiums (Self-Employed)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Premiums paid for yourself and family">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="healthInsurance" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deduction Type</label>
                            <select id="deductionType" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                <option value="standard">Standard Deduction (Recommended)</option>
                                <option value="itemized">Itemized Deductions</option>
                            </select>
                        </div>
                        
                        <div id="itemizedSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Total Itemized Deductions
                            </label>
                            <div class="currency-input">
                                <input type="number" id="itemizedDeductions" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(1)" class="text-gray-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="nextStep(3)" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Filing Information -->
                <div id="step3" class="step-content hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Step 3: Filing Information</h2>
                    <p class="text-gray-600 mb-6">Tell us about your filing status and withholdings.</p>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filing Status</label>
                            <select id="filingStatus" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                <option value="single">Single</option>
                                <option value="married_jointly">Married Filing Jointly</option>
                                <option value="married_separately">Married Filing Separately</option>
                                <option value="head_household">Head of Household</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Number of Qualifying Children (under 17)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="For Child Tax Credit calculation">‚ìò</span>
                            </label>
                            <input type="number" id="numChildren" value="0" min="0" max="10"
                                class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                W-2 Federal Tax Withholding (Year-to-Date)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Taxes already withheld from paychecks">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="w2Withholding" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Estimated Payments Already Made This Year
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Quarterly payments already submitted">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="estimatedPaymentsMade" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Prior Year Total Tax Liability
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Line 24 from last year's 1040 (for safe harbor)">‚ìò</span>
                            </label>
                            <div class="currency-input">
                                <input type="number" id="priorYearTax" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(2)" class="text-gray-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="calculateTax()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Calculate My Taxes ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step4" class="step-content hidden">
                    <div class="fade-in">
                        <!-- Main Result Card -->
                        <div class="result-card rounded-xl p-6 md:p-8 text-white text-center mb-6">
                            <p class="text-indigo-100 mb-2">Your Quarterly Estimated Payment</p>
                            <h2 class="text-4xl md:text-5xl font-bold mb-2" id="quarterlyAmount">$0</h2>
                            <p class="text-indigo-200">Due each quarter to avoid penalties</p>
                        </div>

                        <!-- Payment Schedule -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">üìÖ</span> Payment Schedule
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-left text-gray-500 border-b">
                                            <th class="pb-3 font-medium">Quarter</th>
                                            <th class="pb-3 font-medium">Due Date</th>
                                            <th class="pb-3 font-medium text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentSchedule">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Safe Harbor Status -->
                        <div id="safeHarborBox" class="p-4 rounded-lg mb-6">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tax Breakdown -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">üìä</span> Tax Breakdown
                            </h3>
                            <div class="space-y-3" id="taxBreakdown">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Tax Saving Tips -->
                        <div class="bg-emerald-50 rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-emerald-800 mb-4 flex items-center">
                                <span class="mr-2">üí°</span> Tax Saving Opportunities
                            </h3>
                            <div id="taxTips" class="space-y-3 text-emerald-700">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Lead Capture -->
                        <div id="leadCaptureSection" class="bg-indigo-50 rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-indigo-800 mb-2">üìß Get Your Detailed PDF Report</h3>
                            <p class="text-indigo-600 text-sm mb-4">Enter your info to receive a comprehensive breakdown with payment vouchers.</p>
                            
                            <div class="space-y-4">
                                <input type="text" id="leadName" placeholder="Your Name"
                                    class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500">
                                <input type="email" id="leadEmail" placeholder="Email Address"
                                    class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500">
                                <input type="tel" id="leadPhone" placeholder="Phone Number (optional)"
                                    class="w-full px-4 py-3 border border-indigo-200 rounded-lg focus:outline-none focus:border-indigo-500">
                                
                                <button onclick="submitLead()" id="submitLeadBtn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                                    üìÑ Get My PDF Report
                                </button>
                            </div>
                        </div>

                        <!-- Thank You Message (hidden initially) -->
                        <div id="thankYouMessage" class="hidden bg-emerald-50 rounded-xl p-6 mb-6 text-center">
                            <div class="text-4xl mb-3">‚úÖ</div>
                            <h3 class="font-bold text-emerald-800 mb-2">Report Sent!</h3>
                            <p class="text-emerald-600">Check your email for your detailed PDF report.</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="downloadPDF()" class="flex-1 bg-gray-800 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all flex items-center justify-center">
                                <span class="mr-2">üì•</span> Download PDF
                            </button>
                            <button onclick="startOver()" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-all flex items-center justify-center">
                                <span class="mr-2">üîÑ</span> Start Over
                            </button>
                        </div>

                        <!-- CTA Button -->
                        <div class="mt-6">
                            <a href="#" id="ctaButton" class="block w-full btn-primary text-white py-4 rounded-lg font-semibold text-center hover:shadow-lg transition-all">
                                üìû Schedule a Tax Consultation
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-8 text-center text-gray-500 text-sm">
                <p>This calculator provides estimates only and should not be considered tax advice.</p>
                <p class="mt-1">Consult a qualified tax professional for personalized guidance.</p>
                <p class="mt-3" id="footerBranding">Powered by <span id="clientName">Your Tax Pro</span></p>
            </footer>
        </main>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & STATE
        // ============================================
        let clientConfig = null;
        let calculationResults = null;
        let currentStep = 1;

        // 2025 Tax Year Constants
        const TAX_YEAR = 2025;
        const STANDARD_DEDUCTIONS = {
            single: 15000,
            married_jointly: 30000,
            married_separately: 15000,
            head_household: 22500
        };

        const TAX_BRACKETS = {
            single: [
                { min: 0, max: 11925, rate: 0.10 },
                { min: 11925, max: 48475, rate: 0.12 },
                { min: 48475, max: 103350, rate: 0.22 },
                { min: 103350, max: 197300, rate: 0.24 },
                { min: 197300, max: 250525, rate: 0.32 },
                { min: 250525, max: 626350, rate: 0.35 },
                { min: 626350, max: Infinity, rate: 0.37 }
            ],
            married_jointly: [
                { min: 0, max: 23850, rate: 0.10 },
                { min: 23850, max: 96950, rate: 0.12 },
                { min: 96950, max: 206700, rate: 0.22 },
                { min: 206700, max: 394600, rate: 0.24 },
                { min: 394600, max: 501050, rate: 0.32 },
                { min: 501050, max: 751600, rate: 0.35 },
                { min: 751600, max: Infinity, rate: 0.37 }
            ],
            married_separately: [
                { min: 0, max: 11925, rate: 0.10 },
                { min: 11925, max: 48475, rate: 0.12 },
                { min: 48475, max: 103350, rate: 0.22 },
                { min: 103350, max: 197300, rate: 0.24 },
                { min: 197300, max: 250525, rate: 0.32 },
                { min: 250525, max: 375800, rate: 0.35 },
                { min: 375800, max: Infinity, rate: 0.37 }
            ],
            head_household: [
                { min: 0, max: 17000, rate: 0.10 },
                { min: 17000, max: 64850, rate: 0.12 },
                { min: 64850, max: 103350, rate: 0.22 },
                { min: 103350, max: 197300, rate: 0.24 },
                { min: 197300, max: 250500, rate: 0.32 },
                { min: 250500, max: 626350, rate: 0.35 },
                { min: 626350, max: Infinity, rate: 0.37 }
            ]
        };

        // Quarterly Due Dates for 2025
        const QUARTERLY_DUE_DATES = [
            { quarter: 'Q1', date: 'April 15, 2025', period: 'Jan 1 - Mar 31' },
            { quarter: 'Q2', date: 'June 16, 2025', period: 'Apr 1 - May 31' },
            { quarter: 'Q3', date: 'September 15, 2025', period: 'Jun 1 - Aug 31' },
            { quarter: 'Q4', date: 'January 15, 2026', period: 'Sep 1 - Dec 31' }
        ];

        // ============================================
        // LICENSE VALIDATION
        // ============================================
        async function validateLicense() {
            const urlParams = new URLSearchParams(window.location.search);
            const licenseKey = urlParams.get('key');

            if (!licenseKey) {
                showError('MISSING_KEY', 'No license key provided. Please contact your tax professional.');
                return;
            }

            try {
                const response = await fetch(`/api/validate?key=${encodeURIComponent(licenseKey)}`);
                const data = await response.json();

                if (!data.valid) {
                    showError(data.error, data.message);
                    return;
                }

                clientConfig = data.config;
                applyBranding();
                showCalculator();

            } catch (error) {
                console.error('License validation error:', error);
                showError('NETWORK_ERROR', 'Unable to validate license. Please try again.');
            }
        }

        function showError(code, message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
            document.getElementById('errorMessage').textContent = message || `Error: ${code}`;
        }

        function showCalculator() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // ============================================
        // BRANDING
        // ============================================
        function applyBranding() {
            if (!clientConfig) return;

            // Apply primary color
            if (clientConfig.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', clientConfig.primaryColor);
                document.documentElement.style.setProperty('--primary-hover', adjustColor(clientConfig.primaryColor, -20));
            }

            // Apply logo
            if (clientConfig.logo) {
                const logoEl = document.getElementById('clientLogo');
                logoEl.src = clientConfig.logo;
                logoEl.classList.remove('hidden');
            }

            // Apply client name
            if (clientConfig.client) {
                document.getElementById('clientName').textContent = clientConfig.client;
            }

            // Apply CTA button
            if (clientConfig.ctaUrl) {
                document.getElementById('ctaButton').href = clientConfig.ctaUrl;
            }
            if (clientConfig.ctaText) {
                document.getElementById('ctaButton').textContent = clientConfig.ctaText;
            }
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function nextStep(step) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            // Update progress indicators
            document.querySelector(`.step-indicator[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.step-indicator[data-step="${currentStep}"]`).classList.add('completed');
            document.querySelector(`.step-indicator[data-step="${step}"]`).classList.add('active');
            
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep(step) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            // Update progress indicators
            document.querySelector(`.step-indicator[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.step-indicator[data-step="${step}"]`).classList.remove('completed');
            document.querySelector(`.step-indicator[data-step="${step}"]`).classList.add('active');
            
            currentStep = step;
        }

        function startOver() {
            currentStep = 1;
            
            // Reset all step indicators
            document.querySelectorAll('.step-indicator').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index === 0) el.classList.add('active');
                else el.classList.add('bg-gray-200', 'text-gray-500');
            });
            
            // Show step 1, hide others
            document.querySelectorAll('.step-content').forEach((el, index) => {
                if (index === 0) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            
            // Reset lead capture
            document.getElementById('leadCaptureSection').classList.remove('hidden');
            document.getElementById('thankYouMessage').classList.add('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // TAX CALCULATIONS
        // ============================================
        function calculateTax() {
            // Gather inputs
            const w2Wages = parseFloat(document.getElementById('w2Wages').value) || 0;
            const selfEmploymentIncome = parseFloat(document.getElementById('selfEmploymentIncome').value) || 0;
            const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
            const businessExpenses = parseFloat(document.getElementById('businessExpenses').value) || 0;
            const retirementContributions = parseFloat(document.getElementById('retirementContributions').value) || 0;
            const healthInsurance = parseFloat(document.getElementById('healthInsurance').value) || 0;
            const filingStatus = document.getElementById('filingStatus').value;
            const numChildren = parseInt(document.getElementById('numChildren').value) || 0;
            const w2Withholding = parseFloat(document.getElementById('w2Withholding').value) || 0;
            const estimatedPaymentsMade = parseFloat(document.getElementById('estimatedPaymentsMade').value) || 0;
            const priorYearTax = parseFloat(document.getElementById('priorYearTax').value) || 0;
            const deductionType = document.getElementById('deductionType').value;
            const itemizedDeductions = parseFloat(document.getElementById('itemizedDeductions').value) || 0;

            // Calculate Net Self-Employment Income
            const netSelfEmployment = Math.max(0, selfEmploymentIncome - businessExpenses);

            // Calculate Self-Employment Tax
            const seTaxableIncome = netSelfEmployment * 0.9235; // 92.35% is taxable
            const socialSecurityTax = Math.min(seTaxableIncome, 176100) * 0.124; // 2025 SS wage base
            const medicareTax = seTaxableIncome * 0.029;
            const additionalMedicare = Math.max(0, seTaxableIncome - 200000) * 0.009; // Additional Medicare
            const selfEmploymentTax = socialSecurityTax + medicareTax + additionalMedicare;
            const deductibleSETax = selfEmploymentTax / 2;

            // Calculate Gross Income
            const grossIncome = w2Wages + netSelfEmployment + otherIncome;

            // Calculate AGI
            const agi = grossIncome - deductibleSETax - retirementContributions - healthInsurance;

            // Determine Deduction
            const standardDeduction = STANDARD_DEDUCTIONS[filingStatus];
            const deduction = (deductionType === 'itemized' && itemizedDeductions > standardDeduction) 
                ? itemizedDeductions 
                : standardDeduction;

            // Calculate Taxable Income
            const taxableIncome = Math.max(0, agi - deduction);

            // Calculate Federal Income Tax
            const brackets = TAX_BRACKETS[filingStatus];
            let federalIncomeTax = 0;
            let remainingIncome = taxableIncome;

            for (const bracket of brackets) {
                if (remainingIncome <= 0) break;
                const taxableAtBracket = Math.min(remainingIncome, bracket.max - bracket.min);
                federalIncomeTax += taxableAtBracket * bracket.rate;
                remainingIncome -= taxableAtBracket;
            }

            // Calculate Child Tax Credit (simplified)
            const childTaxCredit = numChildren * 2000; // $2,000 per child
            const appliedChildCredit = Math.min(childTaxCredit, federalIncomeTax);

            // Total Tax Before Credits
            const totalTaxBeforeCredits = federalIncomeTax + selfEmploymentTax;
            
            // Total Tax After Credits
            const totalTax = Math.max(0, totalTaxBeforeCredits - appliedChildCredit);

            // Total Payments Already Made
            const totalPaymentsMade = w2Withholding + estimatedPaymentsMade;

            // Remaining Tax Due
            const remainingTaxDue = Math.max(0, totalTax - totalPaymentsMade);

            // Quarterly Payment Amount
            const quarterlyPayment = remainingTaxDue / 4;

            // Safe Harbor Calculations
            const safeHarbor90 = totalTax * 0.90;
            const safeHarbor100 = priorYearTax; // 100% of prior year (110% if AGI > $150k)
            const safeHarborHighIncome = agi > 150000 ? priorYearTax * 1.10 : priorYearTax;

            // Effective Tax Rate
            const effectiveTaxRate = grossIncome > 0 ? (totalTax / grossIncome) * 100 : 0;

            // Store results
            calculationResults = {
                // Income
                w2Wages,
                selfEmploymentIncome,
                otherIncome,
                businessExpenses,
                netSelfEmployment,
                grossIncome,
                
                // Deductions & Adjustments
                retirementContributions,
                healthInsurance,
                deductibleSETax,
                deduction,
                deductionType,
                agi,
                taxableIncome,
                
                // Taxes
                selfEmploymentTax,
                socialSecurityTax,
                medicareTax,
                federalIncomeTax,
                childTaxCredit: appliedChildCredit,
                totalTax,
                
                // Payments
                w2Withholding,
                estimatedPaymentsMade,
                totalPaymentsMade,
                remainingTaxDue,
                quarterlyPayment,
                
                // Safe Harbor
                priorYearTax,
                safeHarbor90,
                safeHarborHighIncome,
                meetsSafeHarbor: totalPaymentsMade >= Math.min(safeHarbor90, safeHarborHighIncome),
                
                // Other
                effectiveTaxRate,
                filingStatus,
                numChildren
            };

            // Display results
            displayResults();
            nextStep(4);
        }

        // ============================================
        // DISPLAY RESULTS
        // ============================================
        function displayResults() {
            const r = calculationResults;

            // Quarterly Amount
            document.getElementById('quarterlyAmount').textContent = formatCurrency(r.quarterlyPayment);

            // Payment Schedule
            const scheduleHtml = QUARTERLY_DUE_DATES.map(q => `
                <tr class="payment-schedule-row">
                    <td class="py-3 font-medium">${q.quarter}</td>
                    <td class="py-3">${q.date}</td>
                    <td class="py-3 text-right font-semibold">${formatCurrency(r.quarterlyPayment)}</td>
                </tr>
            `).join('');
            document.getElementById('paymentSchedule').innerHTML = scheduleHtml;

            // Safe Harbor Box
            const safeHarborBox = document.getElementById('safeHarborBox');
            if (r.meetsSafeHarbor) {
                safeHarborBox.className = 'success-box p-4 rounded-lg mb-6';
                safeHarborBox.innerHTML = `
                    <h4 class="font-bold text-emerald-800 mb-2">‚úÖ Safe Harbor Met</h4>
                    <p class="text-emerald-700 text-sm">Based on your payments, you're on track to meet safe harbor requirements and avoid underpayment penalties.</p>
                `;
            } else {
                safeHarborBox.className = 'warning-box p-4 rounded-lg mb-6';
                safeHarborBox.innerHTML = `
                    <h4 class="font-bold text-amber-800 mb-2">‚ö†Ô∏è Safe Harbor Warning</h4>
                    <p class="text-amber-700 text-sm mb-2">You may be subject to underpayment penalties. To meet safe harbor, pay at least:</p>
                    <ul class="text-amber-700 text-sm ml-4 list-disc">
                        <li>90% of this year's tax: ${formatCurrency(r.safeHarbor90)}</li>
                        <li>100%/110% of prior year tax: ${formatCurrency(r.safeHarborHighIncome)}</li>
                    </ul>
                `;
            }

            // Tax Breakdown
            const breakdownHtml = `
                <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">Gross Income</span>
                    <span class="font-semibold">${formatCurrency(r.grossIncome)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">Self-Employment Tax</span>
                    <span class="font-semibold">${formatCurrency(r.selfEmploymentTax)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">Federal Income Tax</span>
                    <span class="font-semibold">${formatCurrency(r.federalIncomeTax)}</span>
                </div>
                ${r.childTaxCredit > 0 ? `
                <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">Child Tax Credit</span>
                    <span class="font-semibold text-emerald-600">-${formatCurrency(r.childTaxCredit)}</span>
                </div>
                ` : ''}
                <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">Total Tax Liability</span>
                    <span class="font-bold">${formatCurrency(r.totalTax)}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">Less: Withholding & Payments</span>
                    <span class="font-semibold text-emerald-600">-${formatCurrency(r.totalPaymentsMade)}</span>
                </div>
                <div class="flex justify-between py-2 bg-indigo-50 px-3 rounded-lg mt-2">
                    <span class="font-bold text-indigo-800">Remaining Tax Due</span>
                    <span class="font-bold text-indigo-800">${formatCurrency(r.remainingTaxDue)}</span>
                </div>
                <div class="flex justify-between py-2 mt-2">
                    <span class="text-gray-600">Effective Tax Rate</span>
                    <span class="font-semibold">${r.effectiveTaxRate.toFixed(1)}%</span>
                </div>
            `;
            document.getElementById('taxBreakdown').innerHTML = breakdownHtml;

            // Tax Tips
            const tips = [];
            
            if (r.retirementContributions < 23000) {
                tips.push(`<p><strong>Maximize Retirement Contributions:</strong> Consider contributing more to a SEP-IRA (up to $69,000) or Solo 401(k) to reduce taxable income.</p>`);
            }
            
            if (r.netSelfEmployment > 40000 && r.selfEmploymentTax > 6000) {
                tips.push(`<p><strong>Consider S-Corp Election:</strong> At your income level, electing S-Corp status could save you ${formatCurrency(r.selfEmploymentTax * 0.25)} or more in self-employment tax.</p>`);
            }
            
            if (r.healthInsurance === 0 && r.netSelfEmployment > 0) {
                tips.push(`<p><strong>Health Insurance Deduction:</strong> If you pay for your own health insurance, this is a deductible expense that can lower your AGI.</p>`);
            }
            
            tips.push(`<p><strong>Track All Business Expenses:</strong> Ensure you're capturing home office, mileage, equipment, and professional development costs.</p>`);
            
            document.getElementById('taxTips').innerHTML = tips.join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // ============================================
        // LEAD CAPTURE
        // ============================================
        async function submitLead() {
            const name = document.getElementById('leadName').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();

            if (!name || !email) {
                alert('Please enter your name and email address.');
                return;
            }

            const btn = document.getElementById('submitLeadBtn');
            btn.textContent = 'Sending...';
            btn.disabled = true;

            try {
                // Send to webhook
                if (clientConfig && clientConfig.webhook) {
                    await fetch(clientConfig.webhook, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'no-cors',
                        body: JSON.stringify({
                            name,
                            email,
                            phone,
                            source: 'Quarterly Tax Calculator',
                            calculatorType: 'quarterly_estimated_tax',
                            results: {
                                quarterlyPayment: calculationResults.quarterlyPayment,
                                totalTax: calculationResults.totalTax,
                                grossIncome: calculationResults.grossIncome,
                                effectiveTaxRate: calculationResults.effectiveTaxRate
                            }
                        })
                    });
                }

                // Show thank you message
                document.getElementById('leadCaptureSection').classList.add('hidden');
                document.getElementById('thankYouMessage').classList.remove('hidden');

            } catch (error) {
                console.error('Lead submission error:', error);
                alert('There was an error submitting your information. Please try again.');
                btn.textContent = 'üìÑ Get My PDF Report';
                btn.disabled = false;
            }
        }

        // ============================================
        // PDF GENERATION
        // ============================================
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = calculationResults;

            // Colors
            const primaryColor = clientConfig?.primaryColor || '#4f46e5';
            const rgb = hexToRgb(primaryColor);

            // Header
            doc.setFillColor(rgb.r, rgb.g, rgb.b);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('Quarterly Estimated Tax Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Tax Year ${TAX_YEAR}`, 105, 30, { align: 'center' });

            // Client branding
            if (clientConfig?.client) {
                doc.setFontSize(10);
                doc.text(`Prepared by ${clientConfig.client}`, 105, 37, { align: 'center' });
            }

            // Reset text color
            doc.setTextColor(0, 0, 0);
            let y = 55;

            // Main Result Box
            doc.setFillColor(rgb.r, rgb.g, rgb.b);
            doc.roundedRect(20, y, 170, 30, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text('Your Quarterly Estimated Payment:', 105, y + 10, { align: 'center' });
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text(formatCurrency(r.quarterlyPayment), 105, y + 23, { align: 'center' });
            
            y += 40;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');

            // Payment Schedule
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Payment Schedule', 20, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Table header
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y, 170, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.text('Quarter', 25, y + 6);
            doc.text('Due Date', 70, y + 6);
            doc.text('Amount', 160, y + 6);
            y += 10;

            doc.setFont('helvetica', 'normal');
            QUARTERLY_DUE_DATES.forEach((q, i) => {
                if (i % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(20, y - 2, 170, 8, 'F');
                }
                doc.text(q.quarter, 25, y + 4);
                doc.text(q.date, 70, y + 4);
                doc.text(formatCurrency(r.quarterlyPayment), 160, y + 4);
                y += 8;
            });

            y += 10;

            // Tax Breakdown
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Tax Breakdown', 20, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const breakdownItems = [
                ['Gross Income', formatCurrency(r.grossIncome)],
                ['Self-Employment Tax', formatCurrency(r.selfEmploymentTax)],
                ['Federal Income Tax', formatCurrency(r.federalIncomeTax)],
                ['Child Tax Credit', `-${formatCurrency(r.childTaxCredit)}`],
                ['Total Tax Liability', formatCurrency(r.totalTax)],
                ['Less: Withholding & Payments', `-${formatCurrency(r.totalPaymentsMade)}`],
                ['Remaining Tax Due', formatCurrency(r.remainingTaxDue)]
            ];

            breakdownItems.forEach((item, i) => {
                if (i % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(20, y - 2, 170, 8, 'F');
                }
                doc.text(item[0], 25, y + 4);
                doc.text(item[1], 160, y + 4);
                y += 8;
            });

            // Effective Tax Rate
            y += 5;
            doc.text(`Effective Tax Rate: ${r.effectiveTaxRate.toFixed(1)}%`, 25, y);

            // Footer
            y = 270;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('This report is for informational purposes only and does not constitute tax advice.', 105, y, { align: 'center' });
            doc.text('Please consult a qualified tax professional for personalized guidance.', 105, y + 5, { align: 'center' });
            
            if (clientConfig?.client) {
                doc.text(`Generated by ${clientConfig.client}`, 105, y + 12, { align: 'center' });
            }

            // Save
            doc.save(`Quarterly-Tax-Estimate-${TAX_YEAR}.pdf`);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 79, g: 70, b: 229 };
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('deductionType').addEventListener('change', function() {
            const itemizedSection = document.getElementById('itemizedSection');
            if (this.value === 'itemized') {
                itemizedSection.classList.remove('hidden');
            } else {
                itemizedSection.classList.add('hidden');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', validateLicense);
    </script>
</body>
</html>
