<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quarterly Estimated Tax Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #eef2ff;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
        }
        
        .input-field {
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .step-indicator.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step-indicator.completed {
            background-color: #10b981;
            color: white;
        }
        
        .currency-input::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }
        
        .currency-input input { padding-left: 28px; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .success-box {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
        }
        
        /* Blur effect for gated content */
        .blurred-content {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
        }
        
        .gate-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        /* Loading & Error Screens */
        #loadingScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loader {
            width: 50px; height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #errorScreen {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #fee2e2;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 450px;
            width: 90%;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 5px;
        }
        
        .payment-schedule-row:nth-child(odd) { background-color: #f9fafb; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .card-shadow { box-shadow: none; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-white text-lg">Loading Calculator...</p>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen">
        <div class="text-center p-8">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h1 class="text-2xl font-bold text-red-800 mb-2">License Error</h1>
            <p id="errorMessage" class="text-red-600">Unable to validate license.</p>
        </div>
    </div>

    <!-- Lead Capture Modal (for PDF download) -->
    <div id="leadModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üìÑ</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Get Your Free PDF Report</h3>
                <p class="text-gray-600 text-sm">Enter your details to download your personalized quarterly tax report with payment schedule and tax-saving tips.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" id="modalName" placeholder="John Smith"
                        class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                    <input type="email" id="modalEmail" placeholder="john@example.com"
                        class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="tel" id="modalPhone" placeholder="(555) 123-4567"
                        class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                </div>
                
                <button onclick="submitLeadAndDownload()" id="modalSubmitBtn" 
                    class="w-full btn-primary text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                    üì• Download My PDF Report
                </button>
                
                <button onclick="closeModal()" class="w-full text-gray-500 py-2 text-sm hover:text-gray-700">
                    Maybe later
                </button>
            </div>
            
            <p class="text-xs text-gray-400 text-center mt-4">
                üîí Your information is secure and will never be shared.
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="gradient-bg py-6 px-4 no-print">
            <div class="max-w-3xl mx-auto text-center">
                <img id="clientLogo" src="" alt="Logo" class="h-12 mx-auto mb-4 hidden">
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Quarterly Estimated Tax Calculator</h1>
                <p class="text-indigo-100">Calculate your quarterly tax payments and avoid IRS penalties</p>
            </div>
        </header>

        <!-- Calculator Container -->
        <main class="max-w-3xl mx-auto px-4 py-8">
            <!-- Progress Steps -->
            <div class="flex justify-between mb-8 no-print" id="progressSteps">
                <div class="flex flex-col items-center">
                    <div class="step-indicator active w-10 h-10 rounded-full flex items-center justify-center font-semibold mb-2 bg-gray-200 text-gray-500" data-step="1">1</div>
                    <span class="text-xs text-gray-600 hidden md:block">Income</span>
                </div>
                <div class="flex-1 h-0.5 bg-gray-200 self-center mx-2 mt-[-20px]"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-semibold bg-gray-200 text-gray-500 mb-2" data-step="2">2</div>
                    <span class="text-xs text-gray-600 hidden md:block">Deductions</span>
                </div>
                <div class="flex-1 h-0.5 bg-gray-200 self-center mx-2 mt-[-20px]"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-semibold bg-gray-200 text-gray-500 mb-2" data-step="3">3</div>
                    <span class="text-xs text-gray-600 hidden md:block">Filing Info</span>
                </div>
                <div class="flex-1 h-0.5 bg-gray-200 self-center mx-2 mt-[-20px]"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-semibold bg-gray-200 text-gray-500 mb-2" data-step="4">4</div>
                    <span class="text-xs text-gray-600 hidden md:block">Results</span>
                </div>
            </div>

            <!-- Calculator Card -->
            <div class="bg-white rounded-2xl card-shadow p-6 md:p-8">
                <!-- Step 1: Income Information -->
                <div id="step1" class="step-content fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Step 1: Income Information</h2>
                    <p class="text-gray-600 mb-6">Enter your expected annual income for tax year 2025.</p>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                W-2 Wages (if any)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Income from traditional employment with tax withholding">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="w2Wages" value="0" min="0" 
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Self-Employment / Business Income
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="1099 income, freelance, consulting, business revenue">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="selfEmploymentIncome" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Other Income
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Investments, rental income, dividends, interest, etc.">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="otherIncome" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button onclick="nextStep(2)" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Next: Deductions ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 2: Deductions -->
                <div id="step2" class="step-content hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Step 2: Deductions & Expenses</h2>
                    <p class="text-gray-600 mb-6">Enter your business expenses and above-the-line deductions.</p>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Total Business Expenses
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Office supplies, software, travel, marketing, etc.">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="businessExpenses" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Retirement Contributions
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="SEP-IRA (up to $69,000), Solo 401k, Traditional IRA">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="retirementContributions" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Health Insurance Premiums (Self-Employed)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Health, dental, vision premiums for you and family">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="healthInsurance" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deduction Type</label>
                            <select id="deductionType" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                <option value="standard">Standard Deduction (Recommended for most)</option>
                                <option value="itemized">Itemized Deductions</option>
                            </select>
                        </div>
                        
                        <div id="itemizedSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Total Itemized Deductions
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Mortgage interest, state taxes, charity, medical expenses">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="itemizedDeductions" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(1)" class="text-gray-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="nextStep(3)" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Next: Filing Info ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Filing Information -->
                <div id="step3" class="step-content hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Step 3: Filing Information</h2>
                    <p class="text-gray-600 mb-6">Tell us about your filing status and current withholdings.</p>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filing Status</label>
                            <select id="filingStatus" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                                <option value="single">Single</option>
                                <option value="married_jointly">Married Filing Jointly</option>
                                <option value="married_separately">Married Filing Separately</option>
                                <option value="head_household">Head of Household</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Number of Qualifying Children (under 17)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="For Child Tax Credit - $2,000 per child">‚ìò</span>
                            </label>
                            <input type="number" id="numChildren" value="0" min="0" max="10"
                                class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                W-2 Federal Tax Already Withheld
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Check your recent pay stub - 'Federal Tax Withheld' YTD">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="w2Withholding" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Estimated Payments Already Made This Year
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Quarterly payments you've already sent to IRS">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="estimatedPaymentsMade" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Last Year's Total Tax (for Safe Harbor)
                                <span class="tooltip text-gray-400 ml-1" data-tooltip="Line 24 from your 2024 Form 1040">‚ìò</span>
                            </label>
                            <div class="currency-input relative">
                                <input type="number" id="priorYearTax" value="0" min="0"
                                    class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(2)" class="text-gray-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="calculateTax()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Calculate My Taxes ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step4" class="step-content hidden">
                    <div class="fade-in">
                        <!-- Main Result Card - Always Visible -->
                        <div class="result-card rounded-xl p-6 md:p-8 text-white text-center mb-6">
                            <p class="text-indigo-100 mb-2">Your Quarterly Estimated Payment</p>
                            <h2 class="text-4xl md:text-5xl font-bold mb-2" id="quarterlyAmount">$0</h2>
                            <p class="text-indigo-200">Due each quarter to avoid IRS penalties</p>
                        </div>

                        <!-- Annual Summary - Always Visible -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-gray-800 mb-4">üìä Annual Tax Summary</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-white p-4 rounded-lg">
                                    <p class="text-gray-500 text-xs mb-1">Total Tax</p>
                                    <p class="font-bold text-lg" id="summaryTotalTax">$0</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <p class="text-gray-500 text-xs mb-1">Already Paid</p>
                                    <p class="font-bold text-lg text-emerald-600" id="summaryPaid">$0</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <p class="text-gray-500 text-xs mb-1">Still Owe</p>
                                    <p class="font-bold text-lg text-red-600" id="summaryOwed">$0</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <p class="text-gray-500 text-xs mb-1">Tax Rate</p>
                                    <p class="font-bold text-lg" id="summaryRate">0%</p>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Schedule - Always Visible -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-gray-800 mb-4">üìÖ 2025 Payment Schedule</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-left text-gray-500 border-b">
                                            <th class="pb-3 font-medium">Quarter</th>
                                            <th class="pb-3 font-medium">Period</th>
                                            <th class="pb-3 font-medium">Due Date</th>
                                            <th class="pb-3 font-medium text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentSchedule"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Safe Harbor Status - Always Visible -->
                        <div id="safeHarborBox" class="p-4 rounded-lg mb-6"></div>

                        <!-- GATED CONTENT - Detailed Breakdown -->
                        <div class="relative mb-6">
                            <div id="detailedBreakdown" class="bg-gray-50 rounded-xl p-6">
                                <h3 class="font-bold text-gray-800 mb-4">üìã Detailed Tax Breakdown</h3>
                                <div class="space-y-3" id="taxBreakdown"></div>
                            </div>
                            
                            <!-- Gate Overlay -->
                            <div id="breakdownGate" class="gate-overlay rounded-xl">
                                <div class="text-center p-6">
                                    <div class="text-4xl mb-3">üîí</div>
                                    <h4 class="font-bold text-gray-800 mb-2">Unlock Full Tax Breakdown</h4>
                                    <p class="text-gray-600 text-sm mb-4">Enter your email to see the detailed breakdown and download your PDF report.</p>
                                    <button onclick="openModal()" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                                        Unlock Now - It's Free
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- GATED CONTENT - Tax Saving Tips -->
                        <div class="relative mb-6">
                            <div id="taxTipsSection" class="bg-emerald-50 rounded-xl p-6">
                                <h3 class="font-bold text-emerald-800 mb-4">üí° Personalized Tax Saving Tips</h3>
                                <div id="taxTips" class="space-y-3 text-emerald-700"></div>
                            </div>
                            
                            <!-- Gate Overlay -->
                            <div id="tipsGate" class="gate-overlay rounded-xl">
                                <div class="text-center p-6">
                                    <div class="text-4xl mb-3">üí°</div>
                                    <h4 class="font-bold text-gray-800 mb-2">Get Personalized Tax Tips</h4>
                                    <p class="text-gray-600 text-sm mb-4">See how you could save money on taxes with our personalized recommendations.</p>
                                    <button onclick="openModal()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-700">
                                        Show My Tips - Free
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-center mb-6 no-print">
                            <button onclick="handlePDFDownload()" class="bg-gray-800 text-white py-3 px-8 rounded-lg font-semibold hover:bg-gray-700 transition-all flex items-center justify-center">
                                <span class="mr-2">üì•</span> Download PDF Report
                            </button>
                        </div>

                        <!-- CTA Button -->
                        <div class="no-print">
                            <a href="#" id="ctaButton" class="block w-full btn-primary text-white py-4 rounded-lg font-semibold text-center hover:shadow-lg transition-all text-lg">
                                üìû Schedule a Free Tax Consultation
                            </a>
                            <p class="text-center text-gray-500 text-sm mt-2">Get expert help with your quarterly tax payments</p>
                        </div>

                        <!-- Start Over -->
                        <div class="mt-6 text-center no-print">
                            <button onclick="startOver()" class="text-indigo-600 font-medium hover:underline">
                                ‚Ü©Ô∏è Start Over with New Numbers
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trust Indicators -->
            <div class="mt-8 text-center text-gray-500 text-sm no-print">
                <p>‚úì Free to use ‚úì No signup required ‚úì IRS-compliant calculations</p>
                <p class="mt-2">This calculator provides estimates only. Consult a tax professional for advice.</p>
            </div>

            <!-- Footer Branding -->
            <footer class="mt-8 text-center no-print">
                <p class="text-gray-400 text-sm">Powered by <span id="clientName" class="font-medium">Your Tax Professional</span></p>
            </footer>
        </main>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & STATE
        // ============================================
        let clientConfig = null;
        let calculationResults = null;
        let currentStep = 1;
        let leadCaptured = false;

        const TAX_YEAR = 2025;
        
        const STANDARD_DEDUCTIONS = {
            single: 15000,
            married_jointly: 30000,
            married_separately: 15000,
            head_household: 22500
        };

        const TAX_BRACKETS = {
            single: [
                { min: 0, max: 11925, rate: 0.10 },
                { min: 11925, max: 48475, rate: 0.12 },
                { min: 48475, max: 103350, rate: 0.22 },
                { min: 103350, max: 197300, rate: 0.24 },
                { min: 197300, max: 250525, rate: 0.32 },
                { min: 250525, max: 626350, rate: 0.35 },
                { min: 626350, max: Infinity, rate: 0.37 }
            ],
            married_jointly: [
                { min: 0, max: 23850, rate: 0.10 },
                { min: 23850, max: 96950, rate: 0.12 },
                { min: 96950, max: 206700, rate: 0.22 },
                { min: 206700, max: 394600, rate: 0.24 },
                { min: 394600, max: 501050, rate: 0.32 },
                { min: 501050, max: 751600, rate: 0.35 },
                { min: 751600, max: Infinity, rate: 0.37 }
            ],
            married_separately: [
                { min: 0, max: 11925, rate: 0.10 },
                { min: 11925, max: 48475, rate: 0.12 },
                { min: 48475, max: 103350, rate: 0.22 },
                { min: 103350, max: 197300, rate: 0.24 },
                { min: 197300, max: 250525, rate: 0.32 },
                { min: 250525, max: 375800, rate: 0.35 },
                { min: 375800, max: Infinity, rate: 0.37 }
            ],
            head_household: [
                { min: 0, max: 17000, rate: 0.10 },
                { min: 17000, max: 64850, rate: 0.12 },
                { min: 64850, max: 103350, rate: 0.22 },
                { min: 103350, max: 197300, rate: 0.24 },
                { min: 197300, max: 250500, rate: 0.32 },
                { min: 250500, max: 626350, rate: 0.35 },
                { min: 626350, max: Infinity, rate: 0.37 }
            ]
        };

        const QUARTERLY_DUE_DATES = [
            { quarter: 'Q1', date: 'April 15, 2025', period: 'Jan 1 - Mar 31' },
            { quarter: 'Q2', date: 'June 16, 2025', period: 'Apr 1 - May 31' },
            { quarter: 'Q3', date: 'Sept 15, 2025', period: 'Jun 1 - Aug 31' },
            { quarter: 'Q4', date: 'Jan 15, 2026', period: 'Sep 1 - Dec 31' }
        ];

        // ============================================
        // LICENSE VALIDATION
        // ============================================
        async function validateLicense() {
            const urlParams = new URLSearchParams(window.location.search);
            const licenseKey = urlParams.get('key');

            if (!licenseKey) {
                showError('MISSING_KEY', 'No license key provided. Please contact your tax professional.');
                return;
            }

            try {
                const response = await fetch(`/api/validate?key=${encodeURIComponent(licenseKey)}`);
                const data = await response.json();

                if (!data.valid) {
                    showError(data.error, data.message);
                    return;
                }

                clientConfig = data.config;
                applyBranding();
                showCalculator();

            } catch (error) {
                console.error('License validation error:', error);
                showError('NETWORK_ERROR', 'Unable to validate license. Please try again.');
            }
        }

        function showError(code, message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
            document.getElementById('errorMessage').textContent = message || `Error: ${code}`;
        }

        function showCalculator() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // ============================================
        // BRANDING
        // ============================================
        function applyBranding() {
            if (!clientConfig) return;

            if (clientConfig.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', clientConfig.primaryColor);
                document.documentElement.style.setProperty('--primary-hover', adjustColor(clientConfig.primaryColor, -20));
            }

            if (clientConfig.logo) {
                const logoEl = document.getElementById('clientLogo');
                logoEl.src = clientConfig.logo;
                logoEl.classList.remove('hidden');
            }

            if (clientConfig.client) {
                document.getElementById('clientName').textContent = clientConfig.client;
            }

            if (clientConfig.ctaUrl) {
                document.getElementById('ctaButton').href = clientConfig.ctaUrl;
            }
            if (clientConfig.ctaText) {
                document.getElementById('ctaButton').innerHTML = clientConfig.ctaText;
            }
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openModal() {
            document.getElementById('leadModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('leadModal').classList.add('hidden');
        }

        function openEmailModal() {
            document.getElementById('emailModal').classList.remove('hidden');
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
        }

        // ============================================
        // LEAD CAPTURE
        // ============================================
        async function submitLeadAndDownload() {
            const name = document.getElementById('modalName').value.trim();
            const email = document.getElementById('modalEmail').value.trim();
            const phone = document.getElementById('modalPhone').value.trim();

            if (!name || !email) {
                alert('Please enter your name and email address.');
                return;
            }

            const btn = document.getElementById('modalSubmitBtn');
            btn.textContent = 'Processing...';
            btn.disabled = true;

            try {
                await sendToWebhook(name, email, phone, 'pdf_download');
                leadCaptured = true;
                unlockGatedContent();
                closeModal();
                downloadPDF();
            } catch (error) {
                console.error('Error:', error);
            }

            btn.textContent = 'üì• Download My PDF Report';
            btn.disabled = false;
        }

        async function submitLeadAndEmail() {
            const name = document.getElementById('emailModalName').value.trim();
            const email = document.getElementById('emailModalEmail').value.trim();
            const phone = document.getElementById('emailModalPhone').value.trim();

            if (!name || !email) {
                alert('Please enter your name and email address.');
                return;
            }

            const btn = document.getElementById('emailModalSubmitBtn');
            btn.textContent = 'Sending...';
            btn.disabled = true;

            try {
                await sendToWebhook(name, email, phone, 'email_results');
                leadCaptured = true;
                unlockGatedContent();
                closeEmailModal();
                
                // Show success message
                alert('‚úÖ Your results have been sent to ' + email);
            } catch (error) {
                console.error('Error:', error);
            }

            btn.textContent = 'üìß Send to My Email';
            btn.disabled = false;
        }

        async function sendToWebhook(name, email, phone, source) {
            if (clientConfig && clientConfig.webhook) {
                const r = calculationResults;
                
                const webhookData = {
                    // Contact info
                    name: name,
                    firstName: name.split(' ')[0],
                    lastName: name.split(' ').slice(1).join(' '),
                    email: email,
                    phone: phone,
                    
                    // Source tracking
                    source: 'Quarterly Tax Calculator',
                    leadSource: source,
                    calculatorType: 'quarterly_estimated_tax',
                    
                    // Tax calculation results
                    quarterlyPayment: r.quarterlyPayment,
                    totalTax: r.totalTax,
                    remainingTaxDue: r.remainingTaxDue,
                    grossIncome: r.grossIncome,
                    selfEmploymentIncome: r.selfEmploymentIncome,
                    selfEmploymentTax: r.selfEmploymentTax,
                    federalIncomeTax: r.federalIncomeTax,
                    effectiveTaxRate: r.effectiveTaxRate.toFixed(1) + '%',
                    filingStatus: r.filingStatus,
                    numChildren: r.numChildren,
                    
                    // Safe harbor info
                    meetsSafeHarbor: r.meetsSafeHarbor,
                    priorYearTax: r.priorYearTax,
                    
                    // Metadata
                    timestamp: new Date().toISOString(),
                    taxYear: TAX_YEAR
                };

                try {
                    // Send via server-side API to avoid CORS issues
                    const response = await fetch('/api/webhook', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            webhookUrl: clientConfig.webhook,
                            data: webhookData
                        })
                    });
                    
                    const result = await response.json();
                    console.log('Webhook result:', result);
                } catch (error) {
                    console.error('Webhook error:', error);
                }
            }
        }

        function unlockGatedContent() {
            document.getElementById('breakdownGate').style.display = 'none';
            document.getElementById('tipsGate').style.display = 'none';
            document.getElementById('detailedBreakdown').classList.remove('blurred-content');
            document.getElementById('taxTipsSection').classList.remove('blurred-content');
        }

        function handlePDFDownload() {
            if (leadCaptured) {
                downloadPDF();
            } else {
                openModal();
            }
        }

        function handleEmailResults() {
            if (leadCaptured) {
                alert('Your results were already sent to your email!');
            } else {
                openEmailModal();
            }
        }

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function nextStep(step) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            document.querySelector(`.step-indicator[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.step-indicator[data-step="${currentStep}"]`).classList.add('completed');
            document.querySelector(`.step-indicator[data-step="${step}"]`).classList.add('active');
            
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep(step) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            document.querySelector(`.step-indicator[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.step-indicator[data-step="${step}"]`).classList.remove('completed');
            document.querySelector(`.step-indicator[data-step="${step}"]`).classList.add('active');
            
            currentStep = step;
        }

        function startOver() {
            currentStep = 1;
            leadCaptured = false;
            
            document.querySelectorAll('.step-indicator').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index === 0) el.classList.add('active');
            });
            
            document.querySelectorAll('.step-content').forEach((el, index) => {
                if (index === 0) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            
            // Reset gates
            document.getElementById('breakdownGate').style.display = 'flex';
            document.getElementById('tipsGate').style.display = 'flex';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // TAX CALCULATIONS
        // ============================================
        function calculateTax() {
            const w2Wages = parseFloat(document.getElementById('w2Wages').value) || 0;
            const selfEmploymentIncome = parseFloat(document.getElementById('selfEmploymentIncome').value) || 0;
            const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
            const businessExpenses = parseFloat(document.getElementById('businessExpenses').value) || 0;
            const retirementContributions = parseFloat(document.getElementById('retirementContributions').value) || 0;
            const healthInsurance = parseFloat(document.getElementById('healthInsurance').value) || 0;
            const filingStatus = document.getElementById('filingStatus').value;
            const numChildren = parseInt(document.getElementById('numChildren').value) || 0;
            const w2Withholding = parseFloat(document.getElementById('w2Withholding').value) || 0;
            const estimatedPaymentsMade = parseFloat(document.getElementById('estimatedPaymentsMade').value) || 0;
            const priorYearTax = parseFloat(document.getElementById('priorYearTax').value) || 0;
            const deductionType = document.getElementById('deductionType').value;
            const itemizedDeductions = parseFloat(document.getElementById('itemizedDeductions').value) || 0;

            const netSelfEmployment = Math.max(0, selfEmploymentIncome - businessExpenses);

            const seTaxableIncome = netSelfEmployment * 0.9235;
            const socialSecurityTax = Math.min(seTaxableIncome, 176100) * 0.124;
            const medicareTax = seTaxableIncome * 0.029;
            const additionalMedicare = Math.max(0, seTaxableIncome - 200000) * 0.009;
            const selfEmploymentTax = socialSecurityTax + medicareTax + additionalMedicare;
            const deductibleSETax = selfEmploymentTax / 2;

            const grossIncome = w2Wages + netSelfEmployment + otherIncome;
            const agi = grossIncome - deductibleSETax - retirementContributions - healthInsurance;

            const standardDeduction = STANDARD_DEDUCTIONS[filingStatus];
            const deduction = (deductionType === 'itemized' && itemizedDeductions > standardDeduction) 
                ? itemizedDeductions 
                : standardDeduction;

            const taxableIncome = Math.max(0, agi - deduction);

            const brackets = TAX_BRACKETS[filingStatus];
            let federalIncomeTax = 0;
            let remainingIncome = taxableIncome;

            for (const bracket of brackets) {
                if (remainingIncome <= 0) break;
                const taxableAtBracket = Math.min(remainingIncome, bracket.max - bracket.min);
                federalIncomeTax += taxableAtBracket * bracket.rate;
                remainingIncome -= taxableAtBracket;
            }

            const childTaxCredit = numChildren * 2000;
            const appliedChildCredit = Math.min(childTaxCredit, federalIncomeTax);

            const totalTaxBeforeCredits = federalIncomeTax + selfEmploymentTax;
            const totalTax = Math.max(0, totalTaxBeforeCredits - appliedChildCredit);

            const totalPaymentsMade = w2Withholding + estimatedPaymentsMade;
            const remainingTaxDue = Math.max(0, totalTax - totalPaymentsMade);
            const quarterlyPayment = remainingTaxDue / 4;

            const safeHarbor90 = totalTax * 0.90;
            const safeHarborHighIncome = agi > 150000 ? priorYearTax * 1.10 : priorYearTax;

            const effectiveTaxRate = grossIncome > 0 ? (totalTax / grossIncome) * 100 : 0;

            calculationResults = {
                w2Wages, selfEmploymentIncome, otherIncome, businessExpenses,
                netSelfEmployment, grossIncome, retirementContributions,
                healthInsurance, deductibleSETax, deduction, deductionType,
                agi, taxableIncome, selfEmploymentTax, socialSecurityTax,
                medicareTax, federalIncomeTax, childTaxCredit: appliedChildCredit,
                totalTax, w2Withholding, estimatedPaymentsMade, totalPaymentsMade,
                remainingTaxDue, quarterlyPayment, priorYearTax, safeHarbor90,
                safeHarborHighIncome,
                meetsSafeHarbor: totalPaymentsMade >= Math.min(safeHarbor90, safeHarborHighIncome || Infinity),
                effectiveTaxRate, filingStatus, numChildren
            };

            displayResults();
            nextStep(4);
        }

        // ============================================
        // DISPLAY RESULTS
        // ============================================
        function displayResults() {
            const r = calculationResults;

            // Main quarterly amount
            document.getElementById('quarterlyAmount').textContent = formatCurrency(r.quarterlyPayment);

            // Summary cards
            document.getElementById('summaryTotalTax').textContent = formatCurrency(r.totalTax);
            document.getElementById('summaryPaid').textContent = formatCurrency(r.totalPaymentsMade);
            document.getElementById('summaryOwed').textContent = formatCurrency(r.remainingTaxDue);
            document.getElementById('summaryRate').textContent = r.effectiveTaxRate.toFixed(1) + '%';

            // Payment schedule
            const scheduleHtml = QUARTERLY_DUE_DATES.map(q => `
                <tr class="payment-schedule-row">
                    <td class="py-3 font-semibold">${q.quarter}</td>
                    <td class="py-3 text-gray-600">${q.period}</td>
                    <td class="py-3">${q.date}</td>
                    <td class="py-3 text-right font-bold">${formatCurrency(r.quarterlyPayment)}</td>
                </tr>
            `).join('');
            document.getElementById('paymentSchedule').innerHTML = scheduleHtml;

            // Safe harbor
            const safeHarborBox = document.getElementById('safeHarborBox');
            if (r.meetsSafeHarbor || r.priorYearTax === 0) {
                safeHarborBox.className = 'success-box p-4 rounded-lg mb-6';
                safeHarborBox.innerHTML = `
                    <h4 class="font-bold text-emerald-800 mb-2">‚úÖ On Track - No Penalty Risk</h4>
                    <p class="text-emerald-700 text-sm">Based on your current payments, you're meeting safe harbor requirements. Keep making your quarterly payments on time to avoid penalties.</p>
                `;
            } else {
                safeHarborBox.className = 'warning-box p-4 rounded-lg mb-6';
                safeHarborBox.innerHTML = `
                    <h4 class="font-bold text-amber-800 mb-2">‚ö†Ô∏è Underpayment Penalty Risk</h4>
                    <p class="text-amber-700 text-sm mb-2">You may face IRS penalties. To avoid penalties, ensure you pay at least one of these amounts:</p>
                    <ul class="text-amber-700 text-sm ml-4 list-disc">
                        <li>90% of this year's tax: <strong>${formatCurrency(r.safeHarbor90)}</strong></li>
                        ${r.priorYearTax > 0 ? `<li>100% of last year's tax: <strong>${formatCurrency(r.safeHarborHighIncome)}</strong></li>` : ''}
                    </ul>
                `;
            }

            // Detailed breakdown (gated)
            const breakdownHtml = `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">Gross Income</span>
                    <span class="font-semibold">${formatCurrency(r.grossIncome)}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">‚àí Business Expenses</span>
                    <span class="font-semibold text-red-600">-${formatCurrency(r.businessExpenses)}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">Net Self-Employment Income</span>
                    <span class="font-semibold">${formatCurrency(r.netSelfEmployment)}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">Self-Employment Tax (15.3%)</span>
                    <span class="font-semibold">${formatCurrency(r.selfEmploymentTax)}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">Federal Income Tax</span>
                    <span class="font-semibold">${formatCurrency(r.federalIncomeTax)}</span>
                </div>
                ${r.childTaxCredit > 0 ? `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">‚àí Child Tax Credit (${r.numChildren} children)</span>
                    <span class="font-semibold text-emerald-600">-${formatCurrency(r.childTaxCredit)}</span>
                </div>
                ` : ''}
                <div class="flex justify-between py-2 border-b bg-gray-100 px-2 rounded">
                    <span class="font-bold">Total Tax Liability</span>
                    <span class="font-bold">${formatCurrency(r.totalTax)}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">‚àí W-2 Withholding</span>
                    <span class="font-semibold text-emerald-600">-${formatCurrency(r.w2Withholding)}</span>
                </div>
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-600">‚àí Estimated Payments Made</span>
                    <span class="font-semibold text-emerald-600">-${formatCurrency(r.estimatedPaymentsMade)}</span>
                </div>
                <div class="flex justify-between py-3 bg-indigo-100 px-3 rounded-lg mt-2">
                    <span class="font-bold text-indigo-800">Remaining Tax Due</span>
                    <span class="font-bold text-indigo-800">${formatCurrency(r.remainingTaxDue)}</span>
                </div>
            `;
            document.getElementById('taxBreakdown').innerHTML = breakdownHtml;

            // Tax tips (gated)
            const tips = [];
            
            if (r.netSelfEmployment > 50000 && r.selfEmploymentTax > 7000) {
                const savings = Math.round(r.selfEmploymentTax * 0.25);
                tips.push(`
                    <div class="bg-white p-4 rounded-lg border border-emerald-200">
                        <h4 class="font-semibold text-emerald-800 mb-1">üíº Consider S-Corp Election</h4>
                        <p class="text-sm">At your income level, electing S-Corp status could save you approximately <strong>${formatCurrency(savings)}</strong> in self-employment tax annually.</p>
                    </div>
                `);
            }
            
            if (r.retirementContributions < 20000 && r.netSelfEmployment > 30000) {
                tips.push(`
                    <div class="bg-white p-4 rounded-lg border border-emerald-200">
                        <h4 class="font-semibold text-emerald-800 mb-1">üè¶ Maximize Retirement Contributions</h4>
                        <p class="text-sm">You could contribute up to <strong>$69,000</strong> to a SEP-IRA or Solo 401(k), reducing your taxable income significantly.</p>
                    </div>
                `);
            }
            
            if (r.healthInsurance === 0 && r.netSelfEmployment > 20000) {
                tips.push(`
                    <div class="bg-white p-4 rounded-lg border border-emerald-200">
                        <h4 class="font-semibold text-emerald-800 mb-1">üè• Health Insurance Deduction</h4>
                        <p class="text-sm">If you pay for your own health insurance, premiums are 100% deductible and reduce your AGI directly.</p>
                    </div>
                `);
            }
            
            tips.push(`
                <div class="bg-white p-4 rounded-lg border border-emerald-200">
                    <h4 class="font-semibold text-emerald-800 mb-1">üìù Track All Business Expenses</h4>
                    <p class="text-sm">Make sure you're capturing home office, vehicle mileage (67¬¢/mile in 2025), equipment, and professional development costs.</p>
                </div>
            `);

            if (r.quarterlyPayment > 1000) {
                tips.push(`
                    <div class="bg-white p-4 rounded-lg border border-emerald-200">
                        <h4 class="font-semibold text-emerald-800 mb-1">üìÖ Set Up Automatic Payments</h4>
                        <p class="text-sm">Use EFTPS.gov to schedule automatic quarterly payments so you never miss a deadline and avoid penalties.</p>
                    </div>
                `);
            }
            
            document.getElementById('taxTips').innerHTML = tips.join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // ============================================
        // PDF GENERATION
        // ============================================
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = calculationResults;

            const primaryColor = clientConfig?.primaryColor || '#4f46e5';
            const rgb = hexToRgb(primaryColor);

            // Header
            doc.setFillColor(rgb.r, rgb.g, rgb.b);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('Quarterly Tax Report', 105, 18, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(`Tax Year ${TAX_YEAR}`, 105, 28, { align: 'center' });

            if (clientConfig?.client) {
                doc.setFontSize(11);
                doc.text(`Prepared by ${clientConfig.client}`, 105, 38, { align: 'center' });
            }

            doc.setTextColor(0, 0, 0);
            let y = 55;

            // Main result box
            doc.setFillColor(rgb.r, rgb.g, rgb.b);
            doc.roundedRect(20, y, 170, 35, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text('Your Quarterly Estimated Payment', 105, y + 12, { align: 'center' });
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text(formatCurrency(r.quarterlyPayment), 105, y + 28, { align: 'center' });
            
            y += 45;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');

            // Summary
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Annual Summary', 20, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const summaryData = [
                ['Total Tax Liability', formatCurrency(r.totalTax)],
                ['Already Paid (Withholding + Estimated)', formatCurrency(r.totalPaymentsMade)],
                ['Remaining Tax Due', formatCurrency(r.remainingTaxDue)],
                ['Effective Tax Rate', r.effectiveTaxRate.toFixed(1) + '%']
            ];
            
            summaryData.forEach((item, i) => {
                doc.text(item[0], 25, y + 5);
                doc.text(item[1], 170, y + 5, { align: 'right' });
                y += 7;
            });

            y += 10;

            // Payment Schedule
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('2025 Payment Schedule', 20, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y, 170, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.text('Quarter', 25, y + 6);
            doc.text('Period', 60, y + 6);
            doc.text('Due Date', 110, y + 6);
            doc.text('Amount', 170, y + 6, { align: 'right' });
            y += 10;

            doc.setFont('helvetica', 'normal');
            QUARTERLY_DUE_DATES.forEach((q, i) => {
                if (i % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(20, y - 2, 170, 8, 'F');
                }
                doc.text(q.quarter, 25, y + 4);
                doc.text(q.period, 60, y + 4);
                doc.text(q.date, 110, y + 4);
                doc.text(formatCurrency(r.quarterlyPayment), 170, y + 4, { align: 'right' });
                y += 8;
            });

            y += 10;

            // Tax Breakdown
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Tax Breakdown', 20, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const breakdownItems = [
                ['Gross Income', formatCurrency(r.grossIncome)],
                ['Self-Employment Tax', formatCurrency(r.selfEmploymentTax)],
                ['Federal Income Tax', formatCurrency(r.federalIncomeTax)],
                ['Child Tax Credit', `-${formatCurrency(r.childTaxCredit)}`],
                ['Total Tax Liability', formatCurrency(r.totalTax)]
            ];

            breakdownItems.forEach((item, i) => {
                if (i % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(20, y - 2, 170, 8, 'F');
                }
                doc.text(item[0], 25, y + 4);
                doc.text(item[1], 170, y + 4, { align: 'right' });
                y += 8;
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('This report is for informational purposes only and does not constitute tax advice.', 105, 275, { align: 'center' });
            doc.text('Please consult a qualified tax professional for personalized guidance.', 105, 280, { align: 'center' });
            
            if (clientConfig?.client) {
                doc.text(`Generated by ${clientConfig.client} | ${new Date().toLocaleDateString()}`, 105, 287, { align: 'center' });
            }

            doc.save(`Quarterly-Tax-Report-${TAX_YEAR}.pdf`);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 79, g: 70, b: 229 };
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('deductionType').addEventListener('change', function() {
            const itemizedSection = document.getElementById('itemizedSection');
            if (this.value === 'itemized') {
                itemizedSection.classList.remove('hidden');
            } else {
                itemizedSection.classList.add('hidden');
            }
        });

        // Close modals on backdrop click
        document.getElementById('leadModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        document.getElementById('emailModal').addEventListener('click', function(e) {
            if (e.target === this) closeEmailModal();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', validateLicense);
    </script>
</body>
</html>
